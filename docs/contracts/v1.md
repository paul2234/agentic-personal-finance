# V1 CLI and Service Contract

This document defines the initial production-oriented contract for a CLI-first accounting
engine where write operations flow through a trusted backend service layer.

## Architecture Flow

- Production flow: `CLI -> Service (Edge Function/API) -> Postgres`
- Local dev can use the same flow by running service endpoints locally.
- CLI never requires database credentials in end-user environments.

## Shared Conventions

### Base URL

- Local: `http://127.0.0.1:54321/functions/v1`
- Production: `<your-project-url>/functions/v1`

### Auth

- All endpoints require a bearer token.
- Header: `Authorization: Bearer <token>`

### Idempotency

- Required for write operations.
- Header: `Idempotency-Key: <uuid-or-stable-key>`
- Same key + same payload returns the original success response.
- Same key + different payload returns `IDEMPOTENCY_CONFLICT`.

### Response Envelope

```json
{
  "success": true,
  "data": {}
}
```

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable message",
    "details": {}
  }
}
```

## CLI Commands (V1)

- `accounts list [--json]`
- `ledger post-entry --file <path> [--idempotency-key <key>] [--json]`
- `raw import --file <path> [--json]`

## Endpoint Contracts

### GET `/get-accounts`

Returns active chart-of-accounts rows sorted by code.

Example success:

```json
{
  "success": true,
  "data": [
    {
      "id": "711b7400-4cc4-4aaa-8365-90b5d46af0a4",
      "code": "1000",
      "name": "Cash Checking",
      "accountType": "ASSET",
      "normalSide": "DEBIT",
      "isActive": true
    }
  ]
}
```

### POST `/post-journal-entry`

Creates and posts a balanced journal entry.

Request body:

```json
{
  "entryDate": "2026-02-20",
  "memo": "Grocery purchase",
  "sourceType": "manual",
  "sourceRef": "cli",
  "lines": [
    {
      "accountCode": "5200",
      "type": "DEBIT",
      "amount": "45.50",
      "description": "Groceries"
    },
    {
      "accountCode": "1000",
      "type": "CREDIT",
      "amount": "45.50",
      "description": "Paid from checking"
    }
  ]
}
```

### POST `/import-raw-transactions`

Imports raw bank/card transactions for a single mapped account.

Request body:

```json
{
  "source": "bank-csv",
  "accountCode": "1000",
  "fileName": "checking-2026-02.csv",
  "transactions": [
    {
      "externalId": "txn-2026-02-001",
      "occurredAt": "2026-02-18T15:11:00Z",
      "description": "Payroll Deposit",
      "amount": "2500.00",
      "currencyCode": "USD"
    }
  ]
}
```

Success response:

```json
{
  "success": true,
  "data": {
    "importBatchId": "ad6a0f4b-c5d8-48c4-8d71-945ecaf64372",
    "accountId": "711b7400-4cc4-4aaa-8365-90b5d46af0a4",
    "attemptedCount": 3,
    "insertedCount": 3,
    "duplicateCount": 0
  }
}
```

Success response:

```json
{
  "success": true,
  "data": {
    "journalEntryId": "4e4c4978-542b-451b-a6f0-7d562b58f454",
    "journalNumber": "JRN-20260220-7F0B6A9C"
  }
}
```

## Error Codes (V1)

- `VALIDATION_ERROR` - payload shape/type invalid
- `UNBALANCED_ENTRY` - debit and credit totals are not equal
- `MISSING_ACCOUNT` - one or more account codes do not exist or are inactive
- `IDEMPOTENCY_REQUIRED` - missing idempotency key on write endpoint
- `IDEMPOTENCY_CONFLICT` - same key reused with different payload
- `PERIOD_LOCKED` - entry date is in closed period
- `UNAUTHORIZED` - missing/invalid auth token
- `FORBIDDEN` - authenticated but not allowed
- `INTERNAL_ERROR` - unexpected server fault

Example error response:

```json
{
  "success": false,
  "error": {
    "code": "UNBALANCED_ENTRY",
    "message": "Entry is unbalanced: debits 45.5000 != credits 44.5000",
    "details": {
      "debitTotal": "45.5000",
      "creditTotal": "44.5000"
    }
  }
}
```

## Anchor Scenarios

### Happy Paths

- Posting a balanced 2-line journal entry succeeds.
- Posting a balanced multi-line journal entry succeeds.
- Listing accounts returns seeded household accounts sorted by code.

### Core Edge Cases

- Unbalanced journal is rejected and no rows are inserted.
- Unknown account code is rejected and no rows are inserted.
- Duplicate idempotency key + same payload returns original result only.
- Duplicate idempotency key + different payload returns `IDEMPOTENCY_CONFLICT`.

## First Automated Test Targets

- Unit: balance validation (`DEBIT` total equals `CREDIT` total)
- Integration: `POST /v1/journal-entries` happy path
- Integration: `POST /v1/journal-entries` unbalanced path
- Integration: `POST /v1/journal-entries` missing account path
- Integration: idempotency replay and conflict behavior
- E2E: CLI `accounts list --json` via service endpoint
